---
title: "predict_correlated_deg"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
dyn.load("/home/rstudio/libs/libxml2.so.2")
library(DESeq2)
library(dplyr)
library(GenomicRanges)
library(tibble)
library(rtracklayer)
library(ggplot2)
library(stringr)
```

Define a function for DESeq2 count normalisation across replicates:

```{r, include=T}
normalize_counts = function(raw.counts, cond.table, diff.levels) {
  raw.counts = round(raw.counts)
  
  row.names(cond.table) = names(raw.counts)
  
  cond.table$condition = factor(cond.table$condition, levels = diff.levels)
  
  dds = DESeqDataSetFromMatrix(countData = raw.counts,
                               colData = cond.table,
                               design = ~ condition)
  
  dds = DESeq(dds)

  dds = estimateSizeFactors(dds)

  return(counts(dds, normalized = T))
}
```

Load the master table:

```{r, include=T}
master.table = assays(readRDS("../input/salmon.merged.gene_counts.rds"))$counts
```

Normalise gene expression across replicates using DESeq2:

```{r, include=T}
# p1

p1.raw.counts = master.table %>%
  dplyr::select(all_of(unlist(stringr::str_match_all(names(master.table), "WT_D[179]+_p1.*"))))

p1.cond = data.frame(condition = stringr::str_extract(names(p1.raw.counts), "D(7|9|11)"))

p1.diff.levels = c("D7", "D9", "D11")

p1.norm.counts = normalize_counts(p1.raw.counts, p1.cond, p1.diff.levels)

saveRDS(p1.norm.counts,
        file = "../r_results/predict_correlated_deg/p1_norm_counts_expression.rds")

# p2

p2.raw.counts = master.table %>%
  dplyr::select(all_of(unlist(stringr::str_match_all(names(master.table), "WT_D[179]+_p2.*"))))

p2.cond = data.frame(condition = stringr::str_extract(names(p2.raw.counts), "D(7|9|11)"))

p2.diff.levels = c("D7", "D9", "D11")

p2.norm.counts = normalize_counts(p2.raw.counts, p2.cond, p2.diff.levels)

saveRDS(p2.norm.counts,
        file = "../r_results/predict_correlated_deg/p2_norm_counts_expression.rds")

# pMN

pM.raw.counts = master.table %>%
  dplyr::select(all_of(unlist(stringr::str_match_all(names(master.table), "WT_D[179]+_pM.*"))))

pM.cond = data.frame(condition = stringr::str_extract(names(pM.raw.counts), "D(7|9|11)"))

pM.diff.levels = c("D7", "D9", "D11")

pM.norm.counts = normalize_counts(pM.raw.counts, pM.cond, pM.diff.levels)

saveRDS(pM.norm.counts,
        file = "../r_results/predict_correlated_deg/pM_norm_counts_expression.rds")
```

Remove the gene expression master table from memory:

```{r, include=T}
rm(master.table)
```

Upload the chromatin accessibility master table:

```{r, include=T}
master.table = read.delim(file = "../input/consensus_peaks.mRp.clN.featureCounts.txt",
                          header = T,
                          sep = "\t",
                          skip = 1)

names(master.table) = gsub(pattern = ".mLb.clN.bam", replacement = "", x = names(master.table))
```

Normalise chromatin accessibility across replicates using DESeq2:

```{r, include=T}
# p1

p1.raw.counts = master.table %>%
  dplyr::select(all_of(unlist(stringr::str_match_all(names(master.table), "WT_D[179]+_p1.*"))))

p1.cond = data.frame(condition = stringr::str_extract(names(p1.raw.counts), "D(7|9|11)"))

p1.diff.levels = c("D7", "D9", "D11")

p1.norm.counts = normalize_counts(p1.raw.counts, p1.cond, p1.diff.levels)

saveRDS(p1.norm.counts,
        file = "../r_results/predict_correlated_deg/p1_norm_counts_accessibility.rds")

# p2

p2.raw.counts = master.table %>%
  dplyr::select(all_of(unlist(stringr::str_match_all(names(master.table), "WT_D[179]+_p2.*"))))

p2.cond = data.frame(condition = stringr::str_extract(names(p2.raw.counts), "D(7|9|11)"))

p2.diff.levels = c("D7", "D9", "D11")

p2.norm.counts = normalize_counts(p2.raw.counts, p2.cond, p2.diff.levels)

saveRDS(p2.norm.counts,
        file = "../r_results/predict_correlated_deg/p2_norm_counts_accessibility.rds")

# pMN

pM.raw.counts = master.table %>%
  dplyr::select(all_of(unlist(stringr::str_match_all(names(master.table), "WT_D[179]+_pM.*"))))

pM.cond = data.frame(condition = stringr::str_extract(names(pM.raw.counts), "D(7|9|11)"))

pM.diff.levels = c("D7", "D9", "D11")

pM.norm.counts = normalize_counts(pM.raw.counts, pM.cond, pM.diff.levels)

saveRDS(pM.norm.counts,
        file = "../r_results/predict_correlated_deg/pM_norm_counts_accessibility.rds")
```

Remove the chromatin accessibility master table from memory:

```{r, include=T}
rm(master.table)
```

Upload sets of NFIA-dependent regions:

```{r, include=T}
# Joaquina's parameters for choosing significantly regulated regions
fdr = 0.01
min.l2fc = 2 # Min log2(fold change)
min.baseMean = 100

p1.dep.regions = import(paste0("../r_results/select_diff_regions/p1_dep_ranges", 
                               "_fdr", fdr, "_min-l2fc", min.l2fc, "_min-baseMean", min.baseMean,
                               ".bed"))

p2.dep.regions = import(paste0("../r_results/select_diff_regions/p2_dep_ranges", 
                               "_fdr", fdr, "_min-l2fc", min.l2fc, "_min-baseMean", min.baseMean,
                               ".bed"))

pM.dep.regions = import(paste0("../r_results/select_diff_regions/pM_dep_ranges", 
                               "_fdr", fdr, "_min-l2fc", min.l2fc, "_min-baseMean", min.baseMean,
                               ".bed"))
```

Upload sets of NFIA-dependent genes:

```{r, include=T}
p1.dep.genes = readRDS(file = "../r_results/diff_expression/tables/p1_ref_genes.rds")

p2.dep.genes = readRDS(file = "../r_results/diff_expression/tables/p2_ref_genes.rds")

pM.dep.genes = readRDS(file = "../r_results/diff_expression/tables/pM_ref_genes.rds")
```



