---
title: "diff_accessibility"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
dyn.load("/home/rstudio/libs/libxml2.so.2")
library(DESeq2)
library(dplyr)
library(stringr)
library(apeglm)
library(ggplot2)
dyn.load("/home/rstudio/libs/libgsl.so.25")
dyn.load("/home/rstudio/libs/libgslcblas.so.0")
library(TFBSTools)
library(Biostrings)
```

Set FDR:

```{r, include=T}
fdr = 0.01
```

## Differential accessibility in p1

Find differentially accessible elements in p1:

```{r, include=T}
p1 = read.delim("../results/select_samples/featureCounts_WT_D7_p1_vs_WT_D11_p1.tsv") %>%
  dplyr::select(-X)

names(p1) = gsub(pattern = ".mLb.clN.bam", replacement = "", x = names(p1))

p1.ann = p1[, c(1:6)]

p1.clean = p1[, !(names(p1) %in% names(p1)[1:6])]

rownames(p1.clean) = p1.ann$Geneid

p1.cond = data.frame(condition = stringr::str_extract(names(p1.clean), "D(7|11)"))

row.names(p1.cond) = names(p1.clean)

p1.cond$condition = factor(p1.cond$condition, levels = c("D7", "D11"))

p1.dds = DESeqDataSetFromMatrix(countData = p1.clean,
                                colData = p1.cond,
                                design = ~ condition)
p1.dds = DESeq(p1.dds)

p1.res = results(p1.dds, contrast = c("condition", "D11", "D7"), alpha = fdr)
```

Print a summary of the results:

```{r, include=T}
cat("Number of significantly differentially accessible elements (FDR = 1%):", 
    sum(p1.res$padj < fdr, na.rm = T), 
    "\n")

p1.n.up = nrow(as.data.frame(p1.res) %>% 
  filter(!is.na(padj)) %>%
  filter(padj < fdr) %>%
  filter(log2FoldChange > 0))

cat("Number of upregulated elements (FDR = 1%):", 
    p1.n.up,
    "\n")

p1.n.down = nrow(as.data.frame(p1.res) %>% 
  filter(!is.na(padj)) %>%
  filter(padj < fdr) %>%
  filter(log2FoldChange < 0))

cat("Number of downregulated elements (FDR = 1%):", 
    p1.n.down,
    "\n")

p1.n.all = nrow(as.data.frame(p1.res))

cat("The total number of elements:",
    p1.n.all,
    "\n")

cat("The percentage of significantly differentially accessible elements:",
    round((p1.n.up + p1.n.down) / p1.n.all * 100, 2))
```

Print the names of coefficients:

```{r}
resultsNames(p1.dds)
```

Make an MA plot with variation shrinkage:

```{r}
plotMA(lfcShrink(p1.dds, coef = 2, type = "apeglm"))
```

Do PCA:

```{r, include=T}
p1.rld = rlog(p1.dds)

# Based on the code from DESeq2 vignette: https://bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#principal-component-plot-of-the-samples
p1.pcaData = plotPCA(p1.rld, returnData = T)

p1.percentVar = round(100 * attr(p1.pcaData, "percentVar"), 2)

p = ggplot(p1.pcaData, aes(PC1, PC2, color = condition)) +
  geom_point(size = 2) +
  xlab(paste0("PC1: ", p1.percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", p1.percentVar[2], "% variance")) + 
  coord_fixed() +
  theme_classic()

p

ggsave(filename = "../r_results/diff_accessibility/p1_gliogenesis_diff_accesibility_D11_vs_D7_pca.pdf",
       plot = p)
```

Plot proportions of differentially accessible elements:

```{r, include=T}
p1.freq.up = p1.n.up / p1.n.all

p1.freq.down = p1.n.down / p1.n.all

p1.freq.nonsign = 1 - p1.freq.up - p1.freq.down

p1.freq.df = data.frame(freq     = c(p1.freq.up, p1.freq.down, p1.freq.nonsign),
                        category = c("Up",       "Down",       "Non-significant"),
                        element_type = "Elements") %>%
  dplyr::mutate(category = factor(category, levels = category))

p = ggplot(p1.freq.df) +
  geom_col(aes(x = element_type,
               y = freq,
               fill = category)) + 
  theme_classic()

p

ggsave(filename = "../r_results/diff_accessibility/p1_gliogenesis_diff_accesibility_D11_vs_D7_proportions.pdf",
       plot = p)
```

Save the DESeq2 output table as an RDS object:

```{r, include=T}
saveRDS(p1.res, file = "../r_results/diff_accessibility/p1_deseq2_results.rds")
```

## Differential accessibility in p2

Find differentially accessible elements in p2:

```{r, include=T}
p2 = read.delim("../results/select_samples/featureCounts_WT_D7_p2_vs_WT_D11_p2.tsv") %>%
  dplyr::select(-X)

names(p2) = gsub(pattern = ".mLb.clN.bam", replacement = "", x = names(p2))

p2.ann = p2[, c(1:6)]

p2.clean = p2[, !(names(p2) %in% names(p2)[1:6])]

rownames(p2.clean) = p2.ann$Geneid

p2.cond = data.frame(condition = stringr::str_extract(names(p2.clean), "D(7|11)"))

row.names(p2.cond) = names(p2.clean)

p2.cond$condition = factor(p2.cond$condition, levels = c("D7", "D11"))

p2.dds = DESeqDataSetFromMatrix(countData = p2.clean,
                                colData = p2.cond,
                                design = ~ condition)
p2.dds = DESeq(p2.dds)

p2.res = results(p2.dds, contrast = c("condition", "D11", "D7"), alpha = fdr)
```

Print a summary of the results:

```{r, include=T}
cat("Number of significantly differentially accessible elements (FDR = 1%):", 
    sum(p2.res$padj < fdr, na.rm = T), 
    "\n")

p2.n.up = nrow(as.data.frame(p2.res) %>% 
  filter(!is.na(padj)) %>%
  filter(padj < fdr) %>%
  filter(log2FoldChange > 0))

cat("Number of upregulated elements (FDR = 1%):", 
    p2.n.up,
    "\n")

p2.n.down = nrow(as.data.frame(p2.res) %>% 
  filter(!is.na(padj)) %>%
  filter(padj < fdr) %>%
  filter(log2FoldChange < 0))

cat("Number of downregulated elements (FDR = 1%):", 
    p2.n.down,
    "\n")

p2.n.all = nrow(as.data.frame(p2.res))

cat("The total number of elements:",
    p2.n.all,
    "\n")

cat("The percentage of significantly differentially accessible elements:",
    round((p2.n.up + p2.n.down) / p2.n.all * 100, 2))
```

Print the names of coefficients:

```{r}
resultsNames(p2.dds)
```

Make an MA plot with variation shrinkage:

```{r}
plotMA(lfcShrink(p2.dds, coef = 2, type = "apeglm"))
```

Do PCA:

```{r, include=T}
p2.rld = rlog(p2.dds)

# Based on the code from DESeq2 vignette: https://bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#principal-component-plot-of-the-samples
p2.pcaData = plotPCA(p2.rld, returnData = T)

p2.percentVar = round(100 * attr(p2.pcaData, "percentVar"), 2)

p = ggplot(p2.pcaData, aes(PC1, PC2, color = condition)) +
  geom_point(size = 2) +
  xlab(paste0("PC1: ", p2.percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", p2.percentVar[2], "% variance")) + 
  ylim(-3, 3) +
  coord_fixed() +
  theme_classic()

p

ggsave(filename = "../r_results/diff_accessibility/p2_gliogenesis_diff_accesibility_D11_vs_D7_pca.pdf",
       plot = p)
```

Plot proportions of differentially accessible elements:

```{r, include=T}
p2.freq.up = p2.n.up / p2.n.all

p2.freq.down = p2.n.down / p2.n.all

p2.freq.nonsign = 1 - p2.freq.up - p2.freq.down

p2.freq.df = data.frame(freq     = c(p2.freq.up, p2.freq.down, p2.freq.nonsign),
                        category = c("Up",       "Down",       "Non-significant"),
                        element_type = "Elements") %>%
  dplyr::mutate(category = factor(category, levels = category))

p = ggplot(p2.freq.df) +
  geom_col(aes(x = element_type,
               y = freq,
               fill = category)) + 
  theme_classic()

p

ggsave(filename = "../r_results/diff_accessibility/p2_gliogenesis_diff_accesibility_D11_vs_D7_proportions.pdf",
       plot = p)
```

Save the DESeq2 output table as an RDS object:

```{r, include=T}
saveRDS(p2.res, file = "../r_results/diff_accessibility/p2_deseq2_results.rds")
```

## Differential accessibility in pMN

Find differentially accessible elements in pMN:

```{r, include=T}
pMN = read.delim("../results/select_samples/featureCounts_WT_D7_pM_vs_WT_D11_pM.tsv") %>%
  dplyr::select(-X)

names(pMN) = gsub(pattern = ".mLb.clN.bam", replacement = "", x = names(pMN))

pMN.ann = pMN[, c(1:6)]

pMN.clean = pMN[, !(names(pMN) %in% names(pMN)[1:6])]

rownames(pMN.clean) = pMN.ann$Geneid

pMN.cond = data.frame(condition = stringr::str_extract(names(pMN.clean), "D(7|11)"))

row.names(pMN.cond) = names(pMN.clean)

pMN.cond$condition = factor(pMN.cond$condition, levels = c("D7", "D11"))

pMN.dds = DESeqDataSetFromMatrix(countData = pMN.clean,
                                colData = pMN.cond,
                                design = ~ condition)
pMN.dds = DESeq(pMN.dds)

pMN.res = results(pMN.dds, contrast = c("condition", "D11", "D7"), alpha = fdr)
```

Print a summary of the results:

```{r, include=T}
cat("Number of significantly differentially accessible elements (FDR = 1%):", 
    sum(pMN.res$padj < fdr, na.rm = T), 
    "\n")

pMN.n.up = nrow(as.data.frame(pMN.res) %>% 
  filter(!is.na(padj)) %>%
  filter(padj < fdr) %>%
  filter(log2FoldChange > 0))

cat("Number of upregulated elements (FDR = 1%):", 
    pMN.n.up,
    "\n")

pMN.n.down = nrow(as.data.frame(pMN.res) %>% 
  filter(!is.na(padj)) %>%
  filter(padj < fdr) %>%
  filter(log2FoldChange < 0))

cat("Number of downregulated elements (FDR = 1%):", 
    pMN.n.down,
    "\n")

pMN.n.all = nrow(as.data.frame(pMN.res))

cat("The total number of elements:",
    pMN.n.all,
    "\n")

cat("The percentage of significantly differentially accessible elements:",
    round((pMN.n.up + pMN.n.down) / pMN.n.all * 100, 2))
```

Print the names of coefficients:

```{r}
resultsNames(pMN.dds)
```

Make an MA plot with variation shrinkage:

```{r}
plotMA(lfcShrink(pMN.dds, coef = 2, type = "apeglm"))
```

Do PCA:

```{r, include=T}
pMN.rld = rlog(pMN.dds)

# Based on the code from DESeq2 vignette: https://bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#principal-component-plot-of-the-samples
pMN.pcaData = plotPCA(pMN.rld, returnData = T)

pMN.percentVar = round(100 * attr(pMN.pcaData, "percentVar"), 2)

p = ggplot(pMN.pcaData, aes(PC1, PC2, color = condition)) +
  geom_point(size = 2) +
  xlab(paste0("PC1: ", pMN.percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", pMN.percentVar[2], "% variance")) + 
  ylim(-3.5, 3.5) +  
  coord_fixed() +
  theme_classic()

p

ggsave(filename = "../r_results/diff_accessibility/pMN_gliogenesis_diff_accesibility_D11_vs_D7_pca.pdf",
       plot = p)
```

Plot proportions of differentially accessible elements:

```{r, include=T}
pMN.freq.up = pMN.n.up / pMN.n.all

pMN.freq.down = pMN.n.down / pMN.n.all

pMN.freq.nonsign = 1 - pMN.freq.up - pMN.freq.down

pMN.freq.df = data.frame(freq     = c(pMN.freq.up, pMN.freq.down, pMN.freq.nonsign),
                        category = c("Up",       "Down",       "Non-significant"),
                        element_type = "Elements") %>%
  dplyr::mutate(category = factor(category, levels = category))

p = ggplot(pMN.freq.df) +
  geom_col(aes(x = element_type,
               y = freq,
               fill = category)) + 
  theme_classic()

p

ggsave(filename = "../r_results/diff_accessibility/pMN_gliogenesis_diff_accesibility_D11_vs_D7_proportions.pdf",
       plot = p)
```

Save the DESeq2 output table as an RDS object:

```{r, include=T}
saveRDS(pMN.res, file = "../r_results/diff_accessibility/pMN_deseq2_results.rds")
```
